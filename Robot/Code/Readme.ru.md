# Настройка esp32 для курса Line-Robot 

[![en](https://img.shields.io/badge/lang-en-red.svg)](Readme.md)
[![ru](https://img.shields.io/badge/lang-ru-red.svg)](Readme.ru.md)

## Содержание

- [**Описание папки**](#описание-папки)
- [**Инструкция по шагам**](#инструкция-по-шагам)
- [**Загрузка основного исполняемого скетча**](#pагрузка-скетча)
- [**Запись данных в eeprom**](#запись-данных-в-eeprom)
- [**Python script с проверкой**](#python-script-с-проверкой)
- [**WEB интерфейс для управления**](#web-интерфейс-для-управления)
- [**Альтернативные варианты управления роботом**](#альтернативные-варианты-управления-роботом)


## Описание директории

- `ondroid-template-mqtt` - базовый скетч для курса  
- `docs/template.md` - описание базового скетча
- `python_scripts` - директория с python скриптами, где `test_mqtt.py` - скрипт для проверки работы esp32, `web_app.py` - веб приложение для управления роботом в режиме реального времени


## Инструция по шагам

1. Загрузить скетч `ondroid-template-mqtt`. [Подробнее](#загрузка-скетча)
2. Вписать конфигурационные данные в память устройства с помощью UART. [Подробнее](#запись-данных-в-eeprom)
3. Протестировать с помощью python скрипта `test_mqtt.py`. [Подробнее](#запись-данных-в-eeprom)


### Загрузка скетча

1. Скачайте библиотеки: 
	- [ArduinoJson](https://docs.arduino.cc/libraries/arduinojson/https://github.com/bblanchon/ArduinoJson) - работа с json
	- [PubSubClient](https://docs.arduino.cc/libraries/pubsubclient) - mqtt клиент
	- [Adafruit ADS1X15](https://docs.arduino.cc/libraries/adafruit-ads1x15) - для чтения данных с АЦП
	- [LineRobot](https://github.com/autolab-fi/LineRobotLibrary) - библиотека ondroid для робота линии и доступна только на github
2. Загрузите скетч `ondroid-template-mqtt` на esp32

### Запись данных в eeprom

При загрузке скетча будет попытка подключения к WiFi сети. Попытка подключение к WiFi будет продолажться 7 секунд. После неудоачной попытки плата перезагрузится, чтобы пропустить
подключение к WiFi и перейти в оффлайн режим, **отправьте в Serial "y"**. Если же esp32 успешно подключилась к WiFi, то **serial команды также будут доступны**.

Формат команд: каждая команда пишется в serial и заканичается символом ";".

Список команд:

- "help" - вывести список команд с описанием
- "get all" - вывести список всех параметров их их значений
- "set *name*=*value*" - установить значение *value* параметра с именем *name*. В качестве *name* должно быть короткое название парметра, которое указано в скобках при вызове функции "get all".
- "save_robot" - сохранить параметры робота.
- "save_network" - сохранить сетевые настройки.
- "reboot" - перезагрузка платы

Важно! Для применения настроек необходимо сохранить изменения командой "save_network" и/или командой "save_robot", а затем перезагрузить плату.

Пример настройки WiFi:

1. Подключить плату по usb
2. Открыть монитор порта
3. Если вы видите попытку подключения к WiFi сети - отправьте "y".
4. Установим SSID WiFi сети с помощью команды "set wssid=MyWiFi;", где MyWifi - это название нашей WiFi сети.
5. Установим пароль WiFi сети с помощью команды "set wpas=password;", где password - это пароль от нашей WiFi сети.
6. Сохраняем настройки с помощью команды "save_network;"
7. Перезапускаем микроконтроллер командой "reboot;"
8. При загрузке ждем подключения к сети. Если подключение не удалось - перепроверьте введенные данные.

### Python script с проверкой

1. Внесите данные для подключения к брокеру в python script `test_mqtt.py`, который находится в папке `python_scripts`. 
2. Создайте виртуальное окружение для питона и запустите(опционально)
3. Установите requirements `pip install -r python_scripts/requirements.txt`.
4. Запустите скрипт `test_mqtt.py`, если вы увидели в выводе: **All works as expected.** - значит всё работает правильно


## WEB интерфейс для управления

В папке python также находится простое web приложение для управления роботом в реальном времени. Для этого:

1. Внесите данные для подключения к брокеру в python script `web_app.py`, который находится в папке `python_scripts`. Также вы можете туда внести ip адрес камеры, таким образом вы сможете видеть стрим в реальном времени на веб странице.
2. Создайте виртуальное окружение для питона и запустите(опционально)
3. Установите requirements `pip install -r python_scripts/requirements.txt`.
4. Запустите скрипт `web_app.py`
5. В браузере, зайдите на страницу `http://localhost:5000/` и вы увидите веб интерфейс

Перед использованием рекомендуем прочитать документацию по template, которая находится в `docs/template.md`, там вы сможете больше узнать о командах, которые могут быть отправлены на робота.

![alt text](<docs/web_interface.png>)


## Альтернативные варианты управления роботом

Вы можете использовать любой mqtt клиент для управления роботом, но соответственно вам необходимо будет самостоятельно изучить работу с ним. А документация по командам для робота находится [здесь](docs/template.ru.md)

