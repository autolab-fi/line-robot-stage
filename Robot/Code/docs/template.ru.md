# Описание базового скетча

Управление роботом осуществляется посредством mqtt протокола. Поэтому для понимания работы системы рекомендуем ознакомиться с этим протоколом.


## Форматы topic

Предположим мы записали в настройках eeprom `MQTT_SYSTEM_TOPIC`= `test/system`, а `MQTT_USER_TOPIC` = `test/verification`, тогда формат топиков будет следующим:

- `test/system/input` - системный ввод, в который отправляются команды
- `test/system/output` - системный вывод, в него плата присылает сообщения в ответ
- `test/verification` - пользовательский вывод, может использоваться студентами, чтобы отправлять сообщения с робота 

В дальнейшем планируется разделить `test/verification` также на `test/verification/input` и `test/verification/output`.

## Список команд

1. Перезагрузка платы
    ```json
        {
            "command":"restart"
        }
    ```

    Ответ от esp

    ```json
        {
            "type":"hello",
            "msg":"Esp32 connected!",
            "version-control-token":"aae8361a-4dad-4434-8357-7dceb7ca6d66"
        }
    ```

2. Узнать состояние батареи
    ```json
        {
            "command": "battery-status"
        }
    ```
    Ответ от esp
    ```json
        {
            "type":"battery-status",
            "voltage": "27.93", 
            "charging": "true"
        }
    ```
    - `charging` - true - робот на зарядке/false - робот не на зарядке
    - `voltage` - заряд батареи

3. Управление движением робота
    ```json
        {
            "command":"move",
            "commands":"",
            "values":[]
        }
    ```
    
    - `commands`: текстовое поле, которое является последовательностью команд. допустимы символы: **‘f’,’b’,’r’,’l’**.
        - **‘f’** - move forward
        - **‘b’** - move backward
        - **‘r’** - turn right
        - **‘l’** - turn left
    - `values`: массив из чисел, являющихся значениями соответствующих команд по порядку из строки commands.

    - Пример - движение прямо 20 см и поворот направо на 45 градусов:
        ```json
            {
                "command":"move",
                "commands":"fr",
                "values":[20,45]
            }
        ```
4.  Начать выполнение кода пользователя
    
    ```json
        {
            "command":"start",
            "set_block":false
        }
    ```
    - `set_block` - имеет логический тип, true - если нужно заблокировать стандартные функции библиотеки. ВАЖНО! если будет отправлен текстовый “false”, то это не будет работать, так как плата воспримет это как string и будет считать значение за true.

    Ответ от esp
    ```json
        {
            "type":"reset",
            "msg":"Reset completed!"
        }
    ```

    **ВАЖНО!** Дважды выполнить эту команду не получиться, так как роботу требуется перезагрузка, чтобы снова выполнить код пользователя. То есть, чтобы повторно начать выполнение кода пользователя, необходимо сначала отправить команду для перезагрузки платы.

5. Движение на зарядную станцию(просто движение назад, пока не появится сигнал на пине зарядки)

    ```json
        {
            "command":"charge"
        }
    ```
6. Обновить прошивку
    
    ```json
        {
            "command":"update",
            "version":"token",
            "url":"http://server.compiler/download..."
        }
    ```

    - `url` - ссылка на скачивание новой прошивки
    - `version` - токен версии, которая соответствует новому коду, если токены на стороне платы совпадет с присланным токеном, то плата просто перезагрузится. Этот токен вшит в скомпилированный код.

    Ответ от esp

    - Если плата успешно обновится, то вы получите сообщение, как при restart, но с новым токеном версии

    - Если же что-то пошло не так, то вы получите сообщение

        ```json
            {
                "type":"error",
                "msg":"Error downloading sketch!",
            }
        ```